<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - Hospital Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="js/api.js"></script>
    <script src="js/session.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .stat-card {
            border-left: 4px solid #11998e;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .table-responsive {
            max-height: 450px;
            overflow-y: auto;
        }

        .status-scheduled {
            background-color: #0dcaf0;
        }

        .status-completed {
            background-color: #198754;
        }

        .status-cancelled {
            background-color: #dc3545;
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Navigation Bar -->
        <nav class="navbar navbar-expand-lg dashboard-header mb-4">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1"><i class="bi bi-hospital"></i> Doctor Portal</span>
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle" type="button" id="userDropdown"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> {{ userName }}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li>
                                <a class="dropdown-item" href="#" @click.prevent="logout">
                                    <i class="bi bi-box-arrow-right"></i> Logout
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <!-- Statistics Cards -->

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="appointments-tab" data-bs-toggle="tab"
                        data-bs-target="#appointments" type="button" role="tab">
                        <i class="bi bi-calendar-event"></i> My Appointments
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="availability-tab" data-bs-toggle="tab" data-bs-target="#availability"
                        type="button" role="tab">
                        <i class="bi bi-calendar3"></i> Availability
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- APPOINTMENTS TAB -->
                <div class="tab-pane fade show active" id="appointments" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-list-ul"></i> Appointment List</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Date & Time</th>
                                            <th>Patient Name</th>
                                            <th>Age</th>
                                            <th>Gender</th>
                                            <th>Contact</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="apt in appointments" :key="apt.AppointmentID">
                                            <td>{{ apt.AppointmentID }}</td>
                                            <td>{{ apt.AppointmentDate }}</td>
                                            <td>{{ apt.PatientName }}</td>
                                            <td>{{ apt.Age }}</td>
                                            <td>{{ apt.Gender }}</td>
                                            <td>{{ apt.Contact }}</td>
                                            <td>
                                                <span class="badge" :class="'status-' + apt.Status.toLowerCase()">
                                                    {{ apt.Status }}
                                                </span>
                                            </td>
                                            <td>
                                                <button v-if="apt.Status === 'Scheduled'"
                                                    class="btn btn-sm btn-success me-1"
                                                    @click="updateAppointmentStatus(apt.AppointmentID, 'Completed')">
                                                    <i class="bi bi-check"></i> Complete
                                                </button>
                                                <button v-if="apt.Status === 'Scheduled'"
                                                    class="btn btn-sm btn-danger me-1"
                                                    @click="updateAppointmentStatus(apt.AppointmentID, 'Cancelled')">
                                                    <i class="bi bi-x"></i> Cancel
                                                </button>
                                                <button v-if="apt.Status === 'Completed'" class="btn btn-sm btn-primary"
                                                    @click="openPrescriptionModal(apt)" data-bs-toggle="modal"
                                                    data-bs-target="#prescriptionModal">
                                                    <i class="bi bi-file-medical"></i> Add Prescription
                                                </button>
                                                <button class="btn btn-sm btn-info"
                                                    @click="viewPatientHistory(apt.PatientID)" data-bs-toggle="modal"
                                                    data-bs-target="#historyModal">
                                                    <i class="bi bi-clock-history"></i> History
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AVAILABILITY TAB -->
                <div class="tab-pane fade" id="availability" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-calendar3"></i> My Availability</h5>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                data-bs-target="#addAvailabilityModal">
                                <i class="bi bi-plus-circle"></i> Add Time Slot
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Day</th>
                                            <th>Start Time</th>
                                            <th>End Time</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="slot in availability" :key="slot.AvailabilityID">
                                            <td>{{ slot.AvailabilityID }}</td>
                                            <td>{{ slot.Day }}</td>
                                            <td>{{ slot.StartTime }}</td>
                                            <td>{{ slot.EndTime }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-info me-1"
                                                    @click="openEditAvailability(slot)" data-bs-toggle="modal"
                                                    data-bs-target="#editAvailabilityModal">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger"
                                                    @click="deleteAvailability(slot.AvailabilityID)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Prescription Modal -->
        <div class="modal fade" id="prescriptionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Prescription</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="addPrescription">
                            <div class="mb-3">
                                <label class="form-label">Patient Name</label>
                                <input :value="currentAppointment.PatientName" class="form-control" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tests Prescribed</label>
                                <textarea v-model="prescription.tests" class="form-control" rows="2"
                                    placeholder="e.g., Blood Test, X-Ray"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Medicine Name</label>
                                <textarea v-model="prescription.medicine" class="form-control" rows="2"
                                    placeholder="e.g., Paracetamol 500mg"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Instructions</label>
                                <textarea v-model="prescription.instructions" class="form-control" rows="3"
                                    placeholder="e.g., Take twice daily after meals"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2"
                                    data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Prescription</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Availability Modal -->
        <div class="modal fade" id="addAvailabilityModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Availability Slot</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="addAvailability">
                            <div class="mb-3">
                                <label class="form-label">Day *</label>
                                <select v-model="newSlot.day" class="form-select" required>
                                    <option value="">Select Day</option>
                                    <option>Monday</option>
                                    <option>Tuesday</option>
                                    <option>Wednesday</option>
                                    <option>Thursday</option>
                                    <option>Friday</option>
                                    <option>Saturday</option>
                                    <option>Sunday</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Start Time * (HH:MM format)</label>
                                <input v-model="newSlot.start_time" type="time" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">End Time * (HH:MM format)</label>
                                <input v-model="newSlot.end_time" type="time" class="form-control" required>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2"
                                    data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Add Slot</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Availability Modal -->
        <div class="modal fade" id="editAvailabilityModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Availability Slot</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="updateAvailability">
                            <div class="mb-3">
                                <label class="form-label">Day</label>
                                <select v-model="editingSlot.Day" class="form-select">
                                    <option>Monday</option>
                                    <option>Tuesday</option>
                                    <option>Wednesday</option>
                                    <option>Thursday</option>
                                    <option>Friday</option>
                                    <option>Saturday</option>
                                    <option>Sunday</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Start Time</label>
                                <input v-model="editingSlot.StartTime" type="time" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">End Time</label>
                                <input v-model="editingSlot.EndTime" type="time" class="form-control">
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2"
                                    data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Update Slot</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient History Modal -->
        <div class="modal fade" id="historyModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Patient Medical History</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="patientHistory.length === 0" class="text-center text-muted py-4">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-2">No medical history found</p>
                        </div>
                        <div v-else class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Doctor</th>
                                        <th>Tests</th>
                                        <th>Medicine</th>
                                        <th>Instructions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="h in patientHistory" :key="h.HistoryID">
                                        <td>{{ h.AppointmentDate }}</td>
                                        <td>{{ h.DoctorName }}<br><small class="text-muted">{{ h.Specialization
                                                }}</small></td>
                                        <td>{{ h.Tests || '-' }}</td>
                                        <td>{{ h.MedicineName || '-' }}</td>
                                        <td>{{ h.Instructions || '-' }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    userName: '',
                    doctorId: null,
                    appointments: [],
                    availability: [],
                    summary: {
                        total_appointments: 0,
                        upcoming_appointments: 0,
                        completed_appointments: 0
                    },
                    currentAppointment: {},
                    prescription: {
                        tests: '',
                        medicine: '',
                        instructions: ''
                    },
                    newSlot: {
                        day: '',
                        start_time: '',
                        end_time: ''
                    },
                    editingSlot: {},
                    patientHistory: []
                };
            },

            async mounted() {
                // Check authentication
                if (!Session.requireAuth() || !Session.requireRole('Doctor')) return;

                const user = Session.get();
                console.log('Session data:', user);
                this.userName = user.name || 'Doctor';
                this.doctorId = user.referenceId;
                console.log('Doctor ID:', this.doctorId);

                await this.loadSummary();
                await this.loadAppointments();
                await this.loadAvailability();
            },

            methods: {
                async loadSummary() {
                    try {
                        console.log('Fetching summary for doctor ID:', this.doctorId);
                        const res = await API.get(`/doctor/dashboard/${this.doctorId}/summary`);
                        console.log('Summary response:', res.data);
                        this.summary = res.data;
                    } catch (err) {
                        console.error('Error loading summary:', err);
                    }
                },

                async loadAppointments() {
                    try {
                        const res = await API.get(`/doctor/appointments/${this.doctorId}`);
                        this.appointments = res.data;
                    } catch (err) {
                        console.error('Error loading appointments:', err);
                        alert('Failed to load appointments');
                    }
                },

                async loadAvailability() {
                    try {
                        const res = await API.get(`/doctor/${this.doctorId}/availability`);
                        this.availability = res.data;
                    } catch (err) {
                        console.error('Error loading availability:', err);
                    }
                },

                async updateAppointmentStatus(appointmentId, status) {
                    if (!confirm(`Mark this appointment as ${status}?`)) return;

                    try {
                        await API.put(`/doctor/appointments/${appointmentId}/status`, { status });
                        alert(`Appointment marked as ${status}!`);
                        await this.loadAppointments();
                        await this.loadSummary();
                    } catch (err) {
                        console.error('Error updating appointment:', err);
                        alert('Failed to update appointment status');
                    }
                },

                openPrescriptionModal(appointment) {
                    this.currentAppointment = appointment;
                    this.prescription = { tests: '', medicine: '', instructions: '' };
                },

                async addPrescription() {
                    try {
                        await API.post(`/doctor/appointments/${this.currentAppointment.AppointmentID}/history`, {
                            patient_id: this.currentAppointment.PatientID,
                            tests: this.prescription.tests,
                            medicine: this.prescription.medicine,
                            instructions: this.prescription.instructions
                        });
                        alert('Prescription added successfully!');
                        bootstrap.Modal.getInstance(document.getElementById('prescriptionModal')).hide();
                        this.prescription = { tests: '', medicine: '', instructions: '' };
                    } catch (err) {
                        console.error('Error adding prescription:', err);
                        alert('Failed to add prescription');
                    }
                },

                async addAvailability() {
                    try {
                        await API.post(`/doctor/${this.doctorId}/availability`, this.newSlot);
                        alert('Availability slot added successfully!');
                        this.newSlot = { day: '', start_time: '', end_time: '' };
                        bootstrap.Modal.getInstance(document.getElementById('addAvailabilityModal')).hide();
                        await this.loadAvailability();
                    } catch (err) {
                        console.error('Error adding availability:', err);
                        alert(err.response?.data?.error || 'Failed to add availability slot');
                    }
                },

                openEditAvailability(slot) {
                    this.editingSlot = { ...slot };
                },

                async updateAvailability() {
                    try {
                        await API.put(`/doctor/availability/${this.editingSlot.AvailabilityID}`, {
                            day: this.editingSlot.Day,
                            start_time: this.editingSlot.StartTime,
                            end_time: this.editingSlot.EndTime
                        });
                        alert('Availability updated successfully!');
                        bootstrap.Modal.getInstance(document.getElementById('editAvailabilityModal')).hide();
                        await this.loadAvailability();
                    } catch (err) {
                        console.error('Error updating availability:', err);
                        alert('Failed to update availability');
                    }
                },

                async deleteAvailability(availabilityId) {
                    if (!confirm('Are you sure you want to delete this availability slot?')) return;

                    try {
                        await API.delete(`/doctor/availability/${availabilityId}`);
                        alert('Availability slot deleted successfully!');
                        await this.loadAvailability();
                    } catch (err) {
                        console.error('Error deleting availability:', err);
                        alert('Failed to delete availability slot');
                    }
                },

                async viewPatientHistory(patientId) {
                    try {
                        const res = await API.get(`/doctor/patients/${patientId}/history`);
                        this.patientHistory = res.data;
                    } catch (err) {
                        console.error('Error loading patient history:', err);
                        alert('Failed to load patient history');
                    }
                },

                logout() {
                    Session.logout();
                }
            }
        }).mount('#app');
    </script>
</body>

</html>